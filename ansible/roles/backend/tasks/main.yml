---
- name: Install MySQL client
  apt:
    name: mysql-client
    state: present

- name: Create app directory
  file:
    path: /opt/epicbook-backend
    state: directory
    mode: '0755'

- name: Create backend server.js
  copy:
    dest: /opt/epicbook-backend/server.js
    content: |
      const express = require('express');
      const mysql = require('mysql2');
      const app = express();
      
      const db = mysql.createConnection({
        host: '{{ mysql_host }}',
        user: '{{ mysql_user }}',
        password: '{{ mysql_password }}',
        database: '{{ mysql_database }}'
      });
      
      app.get('/api/health', (req, res) => {
        res.json({ status: 'Backend is running!' });
      });
      
      app.get('/api/books', (req, res) => {
        db.query('SELECT * FROM books', (err, results) => {
          if (err) return res.status(500).json({ error: err.message });
          res.json(results);
        });
      });
      
      app.listen({{ app_port }}, '0.0.0.0', () => {
        console.log('Backend running on port {{ app_port }}');
      });

- name: Create package.json
  copy:
    dest: /opt/epicbook-backend/package.json
    content: |
      {
        "name": "epicbook-backend",
        "version": "1.0.0",
        "dependencies": {
          "express": "^4.18.2",
          "mysql2": "^3.2.0"
        }
      }

- name: Install Node.js dependencies
  npm:
    path: /opt/epicbook-backend
    state: present

- name: Create systemd service
  copy:
    dest: /etc/systemd/system/epicbook-backend.service
    content: |
      [Unit]
      Description=EpicBook Backend
      After=network.target
      
      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/epicbook-backend
      ExecStart=/usr/bin/node server.js
      Restart=always
      
      [Install]
      WantedBy=multi-user.target

- name: Start backend service
  systemd:
    name: epicbook-backend
    state: started
    enabled: yes
    daemon_reload: yes