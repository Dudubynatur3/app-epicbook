---
# Install Node.js
- name: Install Node.js repository
  shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  args:
    creates: /etc/apt/sources.list.d/nodesource.list

- name: Install Node.js and build tools
  apt:
    name:
      - nodejs
      - build-essential
    state: present
    update_cache: yes

- name: Create frontend app directory
  file:
    path: /opt/epicbook/frontend
    state: directory
    owner: azureuser
    group: azureuser
    mode: '0755'

- name: Copy frontend application code
  synchronize:
    src: "{{ playbook_dir }}/../frontend/"
    dest: /opt/epicbook/frontend/
    delete: no
    recursive: yes
  become: yes
  become_user: azureuser

- name: Create frontend .env file
  copy:
    dest: /opt/epicbook/frontend/.env.local
    owner: azureuser
    group: azureuser
    mode: '0644'
    content: |
      NEXT_PUBLIC_API_URL=http://{{ backend_private_ip }}:{{ backend_port }}
      NODE_ENV=production

- name: Install frontend dependencies
  npm:
    path: /opt/epicbook/frontend
    state: present
  become: yes
  become_user: azureuser

- name: Build Next.js application
  command: npm run build
  args:
    chdir: /opt/epicbook/frontend
  become: yes
  become_user: azureuser
  environment:
    NEXT_PUBLIC_API_URL: "http://{{ backend_private_ip }}:{{ backend_port }}"
    NODE_ENV: production

- name: Create systemd service for frontend
  copy:
    dest: /etc/systemd/system/epicbook-frontend.service
    mode: '0644'
    content: |
      [Unit]
      Description=EpicBook Frontend (Next.js)
      After=network.target

      [Service]
      Type=simple
      User=azureuser
      WorkingDirectory=/opt/epicbook/frontend
      EnvironmentFile=/opt/epicbook/frontend/.env.local
      ExecStart=/usr/bin/npm start
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Enable and start frontend service
  systemd:
    name: epicbook-frontend
    state: started
    enabled: yes

- name: Install Nginx
  apt:
    name: nginx
    state: present

- name: Configure Nginx as reverse proxy
  copy:
    dest: /etc/nginx/sites-available/epicbook
    mode: '0644'
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              proxy_pass http://localhost:{{ frontend_port }};
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          }

          location /api/ {
              proxy_pass http://{{ backend_private_ip }}:{{ backend_port }}/api/;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/epicbook
    dest: /etc/nginx/sites-enabled/epicbook
    state: link

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Test Nginx configuration
  command: nginx -t
  register: nginx_test
  changed_when: false

- name: Restart Nginx
  systemd:
    name: nginx
    state: restarted
    enabled: yes

- name: Wait for frontend to be ready
  wait_for:
    port: "{{ frontend_port }}"
    delay: 10
    timeout: 120

- name: Display frontend status
  debug:
    msg:
      - "Frontend deployed successfully!"
      - "Service: epicbook-frontend"
      - "Internal Port: {{ frontend_port }}"
      - "Public URL: http://{{ frontend_public_ip }}"
      - "Backend API: http://{{ backend_private_ip }}:{{ backend_port }}"
      - "Check status: sudo systemctl status epicbook-frontend"
      - "View logs: sudo journalctl -u epicbook-frontend -f"
